# Starter pipeline
# Start with a minimal pipeline that you can customize to build and deploy your code.
# Add steps that build, run tests, deploy, and more:
# https://aka.ms/yaml

trigger:
- master

variables:
  # ========================================================================
  #                          Mandatory variables 
  # ========================================================================
  Azure.ServiceConnectionId: 'nebbia-partner-network'
  ACR.ContainerRegistryServiceConnnection: 'nebbia-container-registry'
  AKS.ServiceConnectionId: 'nebbia-partner-network'
  ACR.Name: nebbiaregistry
  Chart.Name: codecampster
  Service.Name: mvc
  Image.Name: codecampster/mvc
  Service.Dockerfile: src/Codecamp/Dockerfile
  Release.Name: codecampster
  # ========================================================================
  #                           Optional variables 
  # ========================================================================
  ACR.RepositoryName: '$(ACR.Name)'
  ACR.ImageName: '$(ACR.Name):$(Build.BuildId)'
  ACR.FullName: '$(ACR.Name).azurecr.io'
  ACR.ImageFullName: '$(ACR.FullName)/$(Image.Name)'
  System.Debug: 'false'

stages:
- stage: Build
  displayName: Build
  jobs:  
  - job: Build
    displayName: Build and Publish
    pool:
      vmImage: 'ubuntu-latest'
    steps:
    - task: Docker@2
      displayName: Build and Push
      inputs:
        command: buildAndPush
        containerRegistry: $(ACR.ContainerRegistryServiceConnnection)
        repository: codecampster/$(Service.Name)
        buildContext: .
        Dockerfile: $(Service.Dockerfile)
        tags: $(Build.BuildNumber)

    - task: HelmInstaller@1
      displayName: Helm installer
      inputs: 
        helmVersionToInstall: latest

    - task: HelmDeploy@0
      displayName: 'Init Helm Client'
      inputs:
        connectionType: None
        command: init
        arguments: '--client-only'

    - task: HelmDeploy@0
      displayName: 'Package Helm Charts'
      inputs:
        connectionType: None
        command: package
        chartPath: 'k8s/charts/$(Chart.Name)'
        chartVersion: '$(Build.BuildId)'
        destination: $(Build.ArtifactStagingDirectory)
        updateDependency: true

    - task: AzureCLI@1
      displayName: 'Push helm chart'
      inputs:
        azureSubscription: $(Azure.ServiceConnectionId)
        scriptLocation: inlineScript
        inlineScript: 'az acr helm push -n $(ACR.RepositoryName) $(Build.ArtifactStagingDirectory)/$(Chart.Name)-$(Build.BuildId).tgz'
        conditions: and(succeeded(), eq(variables['Build.SourceBranch'],'refs/heads/master'))
        
    - task: CopyFiles@2
      displayName: "Copy Helm Charts"
      inputs: 
        SourceFolder: './k8s/charts'
        Contents: '**'
        TargetFolder: '$(Build.ArtifactsStagingDirectory)'
    - task: PublishBuildArtifacts@1
      displayName: "Publish Build Artifacts"
      inputs: 
        ArtifactName: 'helm'
        PathtoPublish: '$(Build.ArtifactsStagingDirectory)'